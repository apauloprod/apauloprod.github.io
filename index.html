<!-- social_site/index.php -->
<?php
session_start();
if (isset($_SESSION['user_id'])) {
    header("Location: home.php");
    exit();
}
?>


<!DOCTYPE html>
<html>
<head>
    <title>Social Site</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Welcome to Social Site</h1>
    <a href="signup.php">Sign Up</a> | <a href="login.php">Login</a>
</body>
</html>




<!-- social_site/db.php -->
<?php
$host = 'localhost';
$db = 'socialsite';
$user = 'postgres';
$pass = 'Visionary88!';
$conn = pg_connect("host=$host dbname=$db user=$user password=$pass");
if (!$conn) {
    die("Connection failed: " . pg_last_error());
}
?>

<!-- social_site/signup.php -->
<?php
require 'db.php'; // PostgreSQL db connection

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = trim($_POST['username']);
    $password = trim($_POST['password']);

    if (empty($username) || empty($password)) {
        echo "Username and password are required.";
        exit();
    }

    // Check if username already exists
    $check_sql = "SELECT id FROM users WHERE username = $1";
    $check_result = pg_query_params($conn, $check_sql, array($username));

    if (pg_num_rows($check_result) > 0) {
        echo "Username already exists.";
        exit();
    }

    // Insert new user
    $hashed_password = password_hash($password, PASSWORD_DEFAULT);
    $insert_sql = "INSERT INTO users (username, password) VALUES ($1, $2)";
    $result = pg_query_params($conn, $insert_sql, array($username, $hashed_password));

    if ($result) {
        echo "User created successfully. You can now <a href='login.php'>log in</a>.";
    } else {
        echo "Error creating user.";
    }
}
?>

<form method="POST" action="signup.php">
    <label>Username:</label>
    <input type="text" name="username" required><br>
    <label>Password:</label>
    <input type="password" name="password" required><br>
    <input type="submit" value="Sign Up">
</form>


<!-- social_site/login.php -->
<?php
require 'db.php';
session_start();
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['username'];
    $password = $_POST['password'];
    $sql = "SELECT id, password FROM users WHERE username = $1";
    $result = pg_query_params($conn, $sql, array($username));
    if ($result && pg_num_rows($result) > 0) {
        $row = pg_fetch_assoc($result);
        if (password_verify($password, $row['password'])) {
            $_SESSION['user_id'] = $row['id'];
            header("Location: home.php");
            exit();
        }
    }
    echo "Login failed.";
}
?>
<form method="POST">
    Username: <input type="text" name="username" required><br>
    Password: <input type="password" name="password" required><br>
    <input type="submit" value="Login">
</form>

<!-- social_site/home.php -->
<?php
require 'db.php';
session_start();
if (!isset($_SESSION['user_id'])) {
    header("Location: index.php");
    exit();
}
$user_id = $_SESSION['user_id'];
?>
<h1>Welcome!</h1>
<a href="profile.php">Edit Profile</a> | <a href="post.php">New Post</a> | <a href="feed.php">Community Board</a> | <a href="logout.php">Logout</a>

<!-- social_site/logout.php -->
<?php
session_start();
session_destroy();
header("Location: index.php");
exit();
?>

<!-- social_site/profile.php -->
<?php
require 'db.php';
session_start();
if (!isset($_SESSION['user_id'])) exit();
$user_id = $_SESSION['user_id'];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $name = $_POST['name'];
    $age = $_POST['age'];
    $bio = $_POST['bio'];
    $pic = '';
    if (isset($_FILES['profile_pic'])) {
        $target = 'uploads/' . basename($_FILES['profile_pic']['name']);
        move_uploaded_file($_FILES['profile_pic']['tmp_name'], $target);
        $pic = $target;
    }
    $sql = "UPDATE users SET name=$1, age=$2, bio=$3, profile_pic=$4 WHERE id=$5";
    $params = array($name, $age, $bio, $pic, $user_id);
    pg_query_params($conn, $sql, $params);
    echo "Profile updated.";
}
?>
<form method="POST" enctype="multipart/form-data">
    Name: <input type="text" name="name"><br>
    Age: <input type="number" name="age"><br>
    Bio: <textarea name="bio"></textarea><br>
    Profile Picture: <input type="file" name="profile_pic"><br>
    <input type="submit" value="Save">
</form>

<!-- social_site/post.php -->
<?php
require 'db.php';
session_start();
if (!isset($_SESSION['user_id'])) exit();
$user_id = $_SESSION['user_id'];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $content = $_POST['content'];
    $media = '';
    if (isset($_FILES['media'])) {
        $target = 'uploads/' . basename($_FILES['media']['name']);
        move_uploaded_file($_FILES['media']['tmp_name'], $target);
        $media = $target;
    }
    $sql = "INSERT INTO posts (user_id, content, media) VALUES ($1, $2, $3)";
    $params = array($user_id, $content, $media);
    pg_query_params($conn, $sql, $params);
    echo "Post uploaded.";
}
?>
<form method="POST" enctype="multipart/form-data">
    Content: <textarea name="content"></textarea><br>
    Media (Image/Video): <input type="file" name="media"><br>
    <input type="submit" value="Post">
</form>

<!-- social_site/feed.php -->
<?php
require 'db.php';
$sql = "SELECT posts.id, users.username, content, media FROM posts JOIN users ON posts.user_id = users.id ORDER BY posts.id DESC";
$result = pg_query($conn, $sql);
while ($row = pg_fetch_assoc($result)) {
    echo "<div><h3>" . htmlspecialchars($row['username']) . "</h3>";
    echo "<p>" . htmlspecialchars($row['content']) . "</p>";
    if ($row['media']) echo "<img src='" . htmlspecialchars($row['media']) . "' width='200'><br>";
    echo "<a href='like.php?post_id={$row['id']}'>Like</a> | <a href='comment.php?post_id={$row['id']}'>Comment</a> | <a href='share.php?post_id={$row['id']}'>Share</a>";
    echo "</div><hr>";
}
?>
